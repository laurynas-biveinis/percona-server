#
# Regression tests for InnoDB locking discovered by VATS that apply
# to all lock scheduling policies
#
#
# lock_remove_all_on_table_for_trx needs to grant waiting locks
#
CREATE TABLE t1 (a INT, b INT) ENGINE=InnoDB;
INSERT INTO t1 VALUES (1, 1), (1, 2);
CREATE TABLE t2 (PRIMARY KEY (a)) SELECT * FROM t1;
ERROR 23000: Duplicate entry '1' for key 'PRIMARY'
BEGIN;
CREATE TEMPORARY TABLE t2 (PRIMARY KEY (a)) SELECT * FROM t1;
ERROR 23000: Duplicate entry '1' for key 'PRIMARY'
COMMIT;
DROP TABLE t1;
#
# Test FCFS <-> VATS transitions
#
CREATE TABLE t1 (a INT PRIMARY KEY) ENGINE=InnoDB;
INSERT INTO t1 VALUES (1),(2),(3),(4),(5);
BEGIN;
SELECT a FROM t1 WHERE a = 1 FOR UPDATE;
a
1
BEGIN;
SELECT a FROM t1 WHERE a = 2 FOR UPDATE;
a
2
SET @@GLOBAL.innodb_lock_schedule_algorithm = FCFS;
BEGIN;
SELECT a FROM t1 WHERE a = 2 FOR UPDATE;
BEGIN;
SELECT a FROM t1 WHERE a = 3 FOR UPDATE;
a
3
SELECT a FROM t1 WHERE a = 2 FOR UPDATE;
SET @@GLOBAL.innodb_lock_schedule_algorithm = VATS;
BEGIN;
SELECT a FROM t1 WHERE a = 1 FOR UPDATE;
COMMIT;
a
1
ROLLBACK;
COMMIT;
a
2
ROLLBACK;
a
2
COMMIT;
DROP TABLE t1;
